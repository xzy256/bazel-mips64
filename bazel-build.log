
export PROTOC=/usr/local/bin/protoc
export OS=linux
export ARCH=mips64el
export JAVA_HOME="/opt/j2sdk-image"
export JRE_HOME=${JAVA_HOME}/jre
export CLASSPATH=.:${JAVA_HOME}/lib:${JRE_HOME}/lib
export PATH=${JAVA_HOME}/bin:/usr/local/bin/:$PATH
export JAVA_OPTS="-server -Xms2048m -Xmx2048m"

1.ä¸‹è½½zipåŒ…ï¼Œä¸è¦ä½¿ç”¨git cloneï¼Œå¦åˆ™å°‘äº†è®¸å¤šæ–‡ä»¶
wget https://github.com/bazelbuild/bazel/archive/0.4.5.zip
2.æ–°å»ºæ–‡ä»¶å¤¹ï¼Œè§£å‹
mkdir bazel-0.4.5
cp $DOWNLOAD/bazel-0.4.5-dist.zip bazel-0.4.5
cd bazel-0.4.5
unzip bazel-0.4.5-dist.zip

------------------------------0.4.5------------------------------------------------
[root@localhost bazel]# bash ./compile.sh 
INFO: You can skip this first step by providing a path to the bazel binary as second argument:
INFO:    ./compile.sh compile /path/to/bazel
ğŸƒ  Building Bazel from scratch
ERROR: Must specify PROTOC if not bootstrapping from the distribution artifact

---->ç¼–è¯‘protobuf,åœ°å€https://github.com/google/protobuf/ï¼ˆæŸ¥çœ‹bazelç›®å½•é‡Œthird-parts/protobufä¾èµ–çš„ç‰ˆæœ¬ï¼‰
å¹¶è®¾ç½®/etc/profileç¯å¢ƒå˜é‡ export PROTOC=/usr/bin/protocï¼Œå³å¯

å‚è€ƒè¿™é‡Œé¢æåˆ°çš„è§£å†³åŠæ³•
https://bazel.build/designs/2016/10/11/distribution-artifact.html


[root@localhost bazel]# bash ./compile.sh 
INFO: You can skip this first step by providing a path to the bazel binary as second argument:
INFO:    ./compile.sh compile /path/to/bazel
ğŸƒ  Building Bazel from scratch
ERROR: Must specify GRPC_JAVA_PLUGIN if not bootstrapping from the distribution artifact
---->å»githubä¸‹è½½zipåŒ…ï¼Œä¸è¦ä½¿ç”¨git clone(ç¼ºå°‘protocbufé¡¹ç›®æ–‡ä»¶)

bash ./compile.sh

	[root@localhost bazel-0.4.5]# bash ./compile.sh
	INFO: You can skip this first step by providing a path to the bazel binary as second argument:
	INFO:    ./compile.sh compile /path/to/bazel
	ğŸƒ  Building Bazel from scratch.......
	ğŸƒ  Building Bazel with Bazel.
	.WARNING: /tmp/bazel_WQ0HELiG/out/external/bazel_tools/WORKSPACE:1: Workspace name in /tmp/bazel_WQ0HELiG/out/external/bazel_tools/WORKSPACE (@io_bazel) 
	does not match the name given in the repository's definition (@bazel_tools); this will cause a build error in future versions.
	ERROR: No toolchain found for cpu 'unknown'. Valid cpus are: [
	  piii,
	  armeabi-v7a,
	  x64_windows_msvc,
	  s390x,
	  ios_x86_64,
	].
	INFO: Elapsed time: 9.010s

	ERROR: Could not build Bazel

-----> ä¿®æ”¹è§patch  https://github.com/xzy256/bazel-mips64el/blob/master/1.patch
è¿˜æ˜¯cpu=unknown,åŸå› æ˜¯src/main/java/com/google/devtools/build/lib/rules/cpp/CrosstoolConfigurationLoader.java +333
333     String desiredCpu = cpuTransformer.apply(config.getCpu());
desiredCpu==unknownçš„cpu,è€Œconfig.getCpu()æ¥è‡ª
300     CrosstoolConfigurationIdentifier config =CrosstoolConfigurationIdentifier.fromOptions(options);
è¿½è¸ªoptionsï¼Œå®ƒæ˜¯BuildOptionså¯¹è±¡çš„å®ä¾‹./src/main/java/com/google/devtools/build/lib/analysis/config/BuildOptions.java
public final class BuildOptions implements Cloneable, Serializable
 

ERROR: /home/loongson/??/bazel-0.4.5/src/main/tools/BUILD:3:1: Linking of rule '//src/main/tools:process-wrapper' failed: gcc failed: error executing command 
  (cd /tmp/bazel_1pNZuCmW/out/execroot/bazel-0.4.5 && \
  exec env - \
    PATH=/lib/jvm/java-1.8.0-openjdk-1.8.0.25-6.b17.rc21.fc21.loongson.mips64el/bin:/usr/local/bin/:/lib/jvm/java-1.8.0-openjdk-1.8.0.25-6.b17.rc21.fc21.loongson.mips64el/bin:/usr/local/bin/:/usr/lib64/ccache:/usr/local/bin:/usr/bin:/bin:/usr/local/sbin:/usr/sbin:/home/loongson/.local/bin:/home/loongson/bin \
  /usr/lib64/ccache/gcc -o bazel-out/local-opt/bin/src/main/tools/process-wrapper -Wl,-no-as-needed -Wl,-z,relro,-z,now -B/usr/lib64/ccache -B/usr/bin '-Wl,--build-id=md5' '-Wl,--hash-style=gnu' -pass-exit-codes -Wl,--gc-sections -Wl,@bazel-out/local-opt/bin/src/main/tools/process-wrapper-2.params): com.google.devtools.build.lib.shell.BadExitStatusException: Process exited with status 1.
/usr/bin/ld: .gnu.hash is incompatible with the MIPS ABI
collect2: error: ld returned 1 exit status
Target //src:bazel failed to build
INFO: Elapsed time: 76.139s, Critical Path: 38.71s
+ fail 'Could not build Bazel'
+ local exitCode=1
+ [[ 1 = \0 ]]
+ echo

+ echo 'ERROR: Could not build Bazel'
ERROR: Could not build Bazel
+ exit 1

---->å°†ç¼–è¯‘å‚æ•°  â€œ-Wl,--hash-style=gnuâ€ æ”¹æˆ â€œ-Wl,--hash-style=sysvâ€ ï¼Œè¿™ä¸ªå‚æ•°éœ€è¦ldçš„ç‰ˆæœ¬æ˜¯2.17ä»¥ä¸Šçš„

ERROR: /home/loongson/bazel-0.4.5/src/java_tools/singlejar/BUILD:77:1: error executing shell command: 'set -e;rm -rf bazel-out/host/bin/src/java_tools/singlejar/bootstrap_deploy.jar.build_output;mkdir bazel-out/host/bin/src/java_tools/singlejar/bootstrap_deploy.jar.build_output
unzip -qn bazel-out/h...' failed: bash failed: error executing command 
  (cd /tmp/bazel_txTOolZy/out/execroot/bazel-0.4.5 && \
  exec env - \
    PATH=/lib/jvm/java-1.8.0-openjdk-1.8.0.25-6.b17.rc21.fc21.loongson.mips64el/bin:/usr/local/bin/:/lib/jvm/java-1.8.0-openjdk-1.8.0.25-6.b17.rc21.fc21.loongson.mips64el/bin:/usr/local/bin/:/usr/lib64/ccache:/usr/local/bin:/usr/bin:/bin:/usr/local/sbin:/usr/sbin:/home/loongson/.local/bin:/home/loongson/bin \
  /bin/bash -c 'set -e;rm -rf bazel-out/host/bin/src/java_tools/singlejar/bootstrap_deploy.jar.build_output;mkdir bazel-out/host/bin/src/java_tools/singlejar/bootstrap_deploy.jar.build_output
unzip -qn bazel-out/host/bin/src/java_tools/singlejar/libbootstrap.jar -d bazel-out/host/bin/src/java_tools/singlejar/bootstrap_deploy.jar.build_output
unzip -qn bazel-out/host/bin/src/java_tools/singlejar/libskylark-deps.jar -d bazel-out/host/bin/src/java_tools/singlejar/bootstrap_deploy.jar.build_output
unzip -qn third_party/auto/auto-common-0.3.jar -d bazel-out/host/bin/src/java_tools/singlejar/bootstrap_deploy.jar.build_output
unzip -qn third_party/error_prone/error_prone_annotation-2.0.18.jar -d bazel-out/host/bin/src/java_tools/singlejar/bootstrap_deploy.jar.build_output
unzip -qn third_party/error_prone/error_prone_annotations-2.0.18.jar -d bazel-out/host/bin/src/java_tools/singlejar/bootstrap_deploy.jar.build_output
unzip -qn third_party/error_prone/error_prone_check_api-2.0.18.jar -d bazel-out/host/bin/src/java_tools/singlejar/bootstrap_deploy.jar.build_output
unzip -qn third_party/error_prone/error_prone_core-2.0.18.jar -d bazel-out/host/bin/src/java_tools/singlejar/bootstrap_deploy.jar.build_output
unzip -qn third_party/guava/guava-21.0.jar -d bazel-out/host/bin/src/java_tools/singlejar/bootstrap_deploy.jar.build_output
unzip -qn third_party/jcip_annotations/jcip-annotations-1.0-1.jar -d bazel-out/host/bin/src/java_tools/singlejar/bootstrap_deploy.jar.build_output
unzip -qn third_party/jsr305/jsr-305.jar -d bazel-out/host/bin/src/java_tools/singlejar/bootstrap_deploy.jar.build_output
unzip -qn third_party/pcollections/pcollections-2.1.2.jar -d bazel-out/host/bin/src/java_tools/singlejar/bootstrap_deploy.jar.build_output
unzip -qn bazel-out/host/bin/third_party/checker_framework_dataflow/libbootstrap.jar -d bazel-out/host/bin/src/java_tools/singlejar/bootstrap_deploy.jar.build_output
unzip -qn bazel-out/host/bin/third_party/jformatstring/libbootstrap.jar -d bazel-out/host/bin/src/java_tools/singlejar/bootstrap_deploy.jar.build_output
unzip -qn bazel-out/host/bin/src/main/java/com/google/devtools/build/lib/libshell-skylark.jar -d bazel-out/host/bin/src/java_tools/singlejar/bootstrap_deploy.jar.build_output
external/local_jdk/bin/jar cmf bazel-out/host/bin/src/java_tools/singlejar/bootstrap_MANIFEST.MF bazel-out/host/bin/src/java_tools/singlejar/bootstrap_deploy.jar -C bazel-out/host/bin/src/java_tools/singlejar/bootstrap_deploy.jar.build_output .
touch bazel-out/host/bin/src/java_tools/singlejar/bootstrap_deploy.jar.build_output
'): com.google.devtools.build.lib.shell.BadExitStatusException: Process exited with status 50.
???????
ERROR: I/O error while writing action log: ???????.
Target //src:bazel failed to build
---->å¦‚æœæœ‰è‡ªå·±åŠ å…¥çš„System.out.printlnè°ƒè¯•ä¿¡æ¯ï¼Œåˆ é™¤å†ç¼–è¯‘è¯•è¯•ï¼Œä¸è¡Œçš„è¯æ¢0.5.0çš„ç‰ˆæœ¬(å…·ä½“è§£å†³æ–¹æ¡ˆæœ‰ç‚¹å¿˜äº†)
--------------------------------------0.5.0rc9-------------------------------------------------
ERROR: /tmp/bazel-0.5.0rc9/src/main/cpp/BUILD:74:1: Linking of rule '//src/main/cpp:client' failed: gcc failed: error executing command 
  (cd /tmp/bazel_praBgfrP/out/execroot/bazel-0.5.0rc9 && \
  exec env - \
    PATH=/opt/j2sdk-image/bin:/usr/local/bin/:/usr/lib64/ccache:/usr/local/bin:/usr/bin:/bin:/usr/local/sbin:/usr/sbin:/home/xzy/.local/bin:/home/xzy/bin \
    PWD=/proc/self/cwd \
  /usr/lib64/ccache/gcc -o bazel-out/local-opt/bin/src/main/cpp/client -Wl,-no-as-needed -Wl,-z,relro,-z,now -B/usr/lib64/ccache -B/usr/bin -pass-exit-codes -Wl,--gc-sections -Wl,@bazel-out/local-opt/bin/src/main/cpp/client-2.params): com.google.devtools.build.lib.shell.BadExitStatusException: Process exited with status 1.
/usr/bin/ld: bazel-out/local-opt/bin/src/main/cpp/libblaze_util.a(blaze_util_posix.o): bad reloc symbol index (0x64656966 >= 0xfe) for offset 0x7c in section `.text._ZN5blaze15IsEmacsTerminalEv'
bazel-out/local-opt/bin/src/main/cpp/libblaze_util.a: error adding symbols: Bad value
collect2: error: ld returned 1 exit status
Target //src:bazel failed to build
INFO: Elapsed time: 94.959s, Critical Path: 34.58s
---->å°†gccçš„è·¯å¾„åŠ å…¥åˆ°PATHé‡Œé¢å»å³å¯

ERROR: /tmp/bazel-0.5.0rc9/src/main/protobuf/BUILD:24:2: Building src/main/protobuf/libpackage_manifest_java_proto.jar (1 source jar) failed: Worker process returned an unparseable WorkResponse:

---8<---8<--- Exception details ---8<---8<---
com.google.protobuf.InvalidProtocolBufferException: While parsing a protocol message, the input ended unexpectedly in the middle of a field.  This could mean either that the input has been truncated or that an embedded message misreported its own length.



-----------------------------------------0.5.0----------------------------------------------
ERROR: /home/xzy/test/src/main/java/com/google/devtools/build/lib/BUILD:771:1: Building src/main/java/com/google/devtools/build/lib/libmaven-connector.jar (1 source file) failed: Worker process returned an unparseable WorkResponse:

---8<---8<--- Exception details ---8<---8<---
com.google.protobuf.InvalidProtocolBufferException: While parsing a protocol message, the input ended unexpectedly in the middle of a field.  This could mean either that the input has been truncated or that an embedded message misreported its own length.
---->å†æ¬¡æ‰§è¡Œç¼–è¯‘å‘½ä»¤
ERROR: /home/xzy/test/src/tools/android/java/com/google/devtools/build/android/BUILD:16:1: Building src/tools/android/java/com/google/devtools/build/android/classes.jar () failed: Worker process returned an unparseable WorkResponse:

---8<---8<--- Exception details ---8<---8<---
com.google.protobuf.InvalidProtocolBufferException: While parsing a protocol message, the input ended unexpectedly in the middle of a field.  This could mean either that the input has been truncated or that an embedded message misreported its own length.

ERROR: /home/xzy/test/src/main/java/com/google/devtools/build/lib/buildeventstream/proto/BUILD:10:1: Building src/main/java/com/google/devtools/build/lib/buildeventstream/proto/libbuild_event_stream_java_proto.jar (1 source jar) failed: Worker process returned an unparseable WorkResponse

ERROR: /home/xzy/test/third_party/java/aosp_gradle_core/BUILD:12:1: Building third_party/java/aosp_gradle_core/libaosp_gradle_core.jar (1 source file) failed: Worker process returned an unparseable WorkResponse:

---8<---8<--- Exception details ---8<---8<---
com.google.protobuf.InvalidProtocolBufferException: While parsing a protocol message, the input ended unexpectedly in the middle of a field.  This could mean either that the input has been truncated or that an embedded message misreported its own length.

ERROR: /home/xzy/test/src/main/java/com/google/devtools/build/lib/BUILD:1205:1: Building src/main/java/com/google/devtools/build/lib/bazel/BazelServer.jar () failed: Worker process returned an unparseable WorkResponse:

---8<---8<--- Exception details ---8<---8<---
com.google.protobuf.InvalidProtocolBufferException: While parsing a protocol message, the input ended unexpectedly in the middle of a field.  This could mean either that the input has been truncated or that an embedded message misreported its own length
---->ä¿®æ”¹scripts/bootstrap/bootstrap.sh æŒ‰ç…§https://svnweb.freebsd.org/ports/head/devel/bazel/files/patch-scripts_bootstrap_bootstrap.sh?revision=436446&view=markup

ERROR: /home/xzy/test/src/main/java/com/google/devtools/build/lib/BUILD:277:1: Building src/main/java/com/google/devtools/build/lib/libsingle-line-formatter.jar (1 source file) failed: java failed: error executing command 
  (cd /tmp/bazel_5yLwBSLV/out/execroot/test && \
  exec env - \
    LC_CTYPE=en_US.UTF-8 \
  /opt/j2sdk-image/bin/java -Xbootclasspath/p:third_party/java/jdk/langtools/javac-9-dev-r4023-2.jar -XX:+TieredCompilation '-XX:TieredStopAtLevel=1' -jar bazel-out/host/bin/src/java_tools/buildjar/java/com/google/devtools/build/buildjar/bootstrap_deploy.jar @bazel-out/local-opt/bin/src/main/java/com/google/devtools/build/lib/libsingle-line-formatter.jar-2.params): com.google.devtools.build.lib.shell.AbnormalTerminationException: Process terminated by signal 11.
---->jvmä¸æ”¯æŒTieredCompilationï¼Œæ³¨é‡Šå³å¯



